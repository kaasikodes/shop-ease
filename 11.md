# Simple Microservice Architectural Diagram & Discussion

It‚Äôs always helpful to have a diagram or picture when concepts are being explained‚Äîand software architecture is no exception. Today, we‚Äôll look at the architectural diagram of a simple **e-commerce microservices application**. We'll discuss how the components interact, define the responsibilities of each service, and touch on how to set up a development environment that aligns with this architecture.

---

### üß© Architectural Overview

The diagram (not shown here) illustrates that client requests‚Äîoriginating from a **mobile app** or **web browser**‚Äîare sent to an **API Gateway**. In our case, this gateway will be implemented using **Go**.

The **API Gateway** will forward each request to the appropriate microservice. These services may then communicate:

- **Synchronously**, via **gRPC**
- **Asynchronously**, via a **message broker** like **Kafka** or **RabbitMQ**

Once processing is complete, a response is returned to the client through the API Gateway.

Let discuss what happens to these requests typically when received as shhown in the diagram - The api gateway will the forward the request to the appropriate services, the service can then communicate either synchnously via grpc or asynchronously via the message broker to other servcices and then return an api response to th client via the api gateway service. Now there is an observality & monitoring stack in place to provide visibility to the inner workings of the microservices. Each service will expose a metrics endpoint that promethheus will periodically full from and store in its time series. These will provide insights into relevant information like no of http requests per second, ... which can be used to make better informed decisions like what regions produces the most request, what endpoint is least or most called. Which will help us better improve our system. Logs will be generated by each service and they will be stored, these logs will be rotated and deleted and will not be persissted, but we'll need to store this data in a permananet place and query it as it holds valuable information. In order to do this we will have promtail reads/tail those log files and then push them to loki to be stored. Will likkely inject traceIds into these logs so its easy to link these logs to traces. For traces we'll use an opentelementry sdk to send traces to tempo for storage. We'll then use grafana to connect to loki, prometheus, and tempo and use them as datasources and visaulize those traces, logs, and metrics collected, we create dashboards, make queries on grafaall to provide insights to what is going on on our micro-service system.

---

### üîç Observability & Monitoring Stack

To provide visibility into how our services are functioning, we‚Äôll introduce a basic **observability and monitoring stack**.

#### üìà Metrics

Each service will expose a **Prometheus-compatible `/metrics` endpoint**. Prometheus will **scrape** these endpoints at regular intervals and store the data in a **time-series database**. This enables us to track metrics like:

- Number of HTTP requests per second
- Which endpoints are used most or least
- Region-based traffic patterns

This helps us make informed decisions for performance tuning and feature prioritization.

#### üìÉ Logs

Each microservice will write logs locally. These logs will be **rotated** and **not persisted permanently** by default. However, logs can provide invaluable debugging information. To capture and store them:

- We‚Äôll use **Promtail** to tail the log files.
- Promtail pushes the logs to **Loki** for storage.
- We'll likely **inject `traceId`s** into logs so they can be correlated with distributed traces.

#### üîó Traces

To track requests as they flow across services:

- We'll use the **OpenTelemetry SDK** to generate **distributed traces**.
- Traces will be sent to **Tempo**.
- Using **Grafana**, we‚Äôll connect **Loki**, **Prometheus**, and **Tempo** as data sources to visualize logs, metrics, and traces in a unified dashboard.

This marks the **first and simplest iteration** of our observability system. As the system grows, we'll expand and scale these components accordingly.

---

## Services & Their Expectations

As with any thing worth building its important to have an idea of what is expected in the final product. The table below will provide insights into our services. A table with the following columns Service, Async Comunication in Microservice(The events that service will publish and subscribe to), Sync Communition between services(via grpc) e.g - What grpc endpoints will it expose for other services to use, and Endpoints that will be consumed by the client - available on postman or swagger documentation for consumption by clients like Mobile App, Web Browser
Our Services

- Auth Service
- Notificatio Service
- Order
- Payment
- Product
- Review & Rating
- Search & Recommend
- Subscription & Traffic
- Vendor

## üõ†Ô∏è Setting Up the Dev Environment

We‚Äôve covered a lot conceptually, but let‚Äôs now walk through a simple local development setup that reflects our architecture.

---

### üîÑ Local Setup (All on One Machine)

- All microservices will run **locally** on **different ports**.
- A **single database server** will be used, with **individual databases for each service**.
- Initially, we‚Äôll stick to **SQL databases** (like PostgreSQL), though some services may later adopt **MongoDB** or others.
- All observability tools (Grafana, Prometheus, Loki, etc.) will also be **containerized and run locally**.

---

### üê≥ Sample `docker-compose.yaml`

Here's a simplified snippet of our Docker Compose setup:

```yaml
# also add db to the services
services:
  prometheus:
    image: prom/prometheus
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml
    ports:
      - "9090:9090"

  grafana:
    image: grafana/grafana
    ports:
      - "4000:3000"
    volumes:
      - grafana-data:/var/lib/grafana
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=admin
      - GF_SMTP_ENABLED=true
      - GF_SMTP_HOST=sandbox.smtp.mailtrap.io:2525
      - GF_SMTP_USER=6c53d765680ca4
      - GF_SMTP_PASSWORD=83175273732073
      - GF_SMTP_FROM_ADDRESS=hello@shop-ease.com
      - GF_SMTP_FROM_NAME=Grafana
    depends_on:
      - prometheus

  promtail:
    image: grafana/promtail:2.9.0
    volumes:
      - ./promtail-config.yml:/etc/promtail/promtail-config.yml
      - ../../logs:/var/log/
    command: -config.file=/etc/promtail/promtail-config.yml
    depends_on:
      - loki

  loki:
    image: grafana/loki:latest
    ports:
      - "3100:3100"
    command: -config.file=/etc/loki/local-config.yaml

  tempo:
    image: grafana/tempo:latest
    ports:
      - "3200:3200"
      - "4317:4317" # gRPC OTLP receiver
      - "4318:4318" # HTTP OTLP receiver
    command: ["-config.file=/etc/tempo/tempo.yaml"]
    volumes:
      - ./tempo-config.yaml:/etc/tempo/tempo.yaml

  zookeeper:
    image: confluentinc/cp-zookeeper:latest
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000

  kafka:
    image: confluentinc/cp-kafka:latest
    depends_on:
      - zookeeper
    ports:
      - "9092:9092"
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://localhost:9092
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: "true"

  kafka-ui:
    image: provectuslabs/kafka-ui:latest
    container_name: kafka-ui
    ports:
      - "8080:8080"
    environment:
      - KAFKA_CLUSTERS_0_NAME=local
      - KAFKA_CLUSTERS_0_BOOTSTRAPSERVERS=kafka:9092
    depends_on:
      - kafka

volumes:
  grafana-data:
```

---

### üîß Developer Tools to Install

Set up the following development tools (some can be installed via [Chocolatey](https://chocolatey.org/) on Windows), and for mac:

- `air` ‚Äì For hot-reloading Go apps
- `direnv` ‚Äì For managing environment variables per directory (`.envrc`)
- `Makefile` ‚Äì For consistent command execution
- `protoc` ‚Äì Protocol Buffers compiler
- `Docker` -
- `buf` ‚Äì For working with Protobuf schemas in teams

üëâ We'll walk through how to install and configure each tool in the next chapter.

---

## ‚úÖ Next Up

We'll now begin building out core services and integrations:

- ‚úÖ **Auth Service** ‚Äì User sign-up, login, token generation, etc.
- ‚úÖ **Notification Service** ‚Äì Email, SMS, push notifications
- ‚úÖ **Asynchronous Communication** ‚Äì Intro to Kafka and RabbitMQ setup
- ‚úÖ **API Gateway** ‚Äì Routing, service discovery, authentication

| **Service**             | **Async Communication (Pub/Sub Events)** | **Sync Communication (gRPC APIs)** | **Client-Facing Endpoints**          |
| ----------------------- | ---------------------------------------- | ---------------------------------- | ------------------------------------ |
| Auth Service            | UserCreated, PasswordReset               | Login, Signup, TokenVerification   | `/login`, `/signup`, `/verify-token` |
| Notification Service    | EmailSent, SMSDispatched                 | TriggerNotification                | N/A                                  |
| Order Service           | OrderPlaced, OrderCancelled              | CreateOrder, GetOrderStatus        | `/orders`, `/orders/:id`             |
| Payment Service         | PaymentInitiated, PaymentConfirmed       | ProcessPayment, GetPaymentStatus   | `/pay`, `/status`                    |
| Product Service         | ProductAdded, InventoryUpdated           | GetProduct, UpdateStock            | `/products`, `/products/:id`         |
| Review & Rating Service | ReviewSubmitted, RatingCalculated        | SubmitReview, GetRating            | `/reviews`, `/ratings`               |
| Search & Recommendation | QueryLogged, SearchPerformed             | GetRecommendations                 | `/search`, `/recommendations`        |
| Subscription & Traffic  | PlanUpgraded, UsageLogged                | GetSubscription, LogUsage          | `/subscribe`, `/usage`               |
| Vendor Service          | VendorRegistered, ProductLinked          | RegisterVendor, GetVendorDetails   | `/vendors`, `/vendors/:id`           |
